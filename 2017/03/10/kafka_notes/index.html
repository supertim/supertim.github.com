<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  
  <title>kafka-notes | SuperTim&#39;s Page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
    <meta name="author" content="SuperTim">
  
  
    <meta name="description" content="Introduction

大量log数据产生  包括

用户行为数据：登陆，浏览，点击，赞，分享，评论，搜索 ……
机器行为数据：callstack， calllatency， error， cpu，memory，disk，….

可以用来

搜索相关性，推荐，定向，安全分析">
  
  <meta name="description" content="Introduction

大量log数据产生  包括

用户行为数据：登陆，浏览，点击，赞，分享，评论，搜索 ……
机器行为数据：callstack， calllatency， error， cpu，memory，disk，….

可以用来

搜索相关性，推荐，定向，安全分析">
<meta property="og:type" content="article">
<meta property="og:title" content="kafka-notes">
<meta property="og:url" content="http://yoursite.com/2017/03/10/kafka_notes/index.html">
<meta property="og:site_name" content="SuperTim's Page">
<meta property="og:description" content="Introduction

大量log数据产生  包括

用户行为数据：登陆，浏览，点击，赞，分享，评论，搜索 ……
机器行为数据：callstack， calllatency， error， cpu，memory，disk，….

可以用来

搜索相关性，推荐，定向，安全分析">
<meta property="og:updated_time" content="2017-03-13T02:12:16.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="kafka-notes">
<meta name="twitter:description" content="Introduction

大量log数据产生  包括

用户行为数据：登陆，浏览，点击，赞，分享，评论，搜索 ……
机器行为数据：callstack， calllatency， error， cpu，memory，disk，….

可以用来

搜索相关性，推荐，定向，安全分析">
  
    <link rel="alternate" href="/atom.xml" title="SuperTim&#39;s Page" type="application/atom+xml">
  
  
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  <!--[if lt IE 9]><script src="//cdn.bootcss.com/html5shiv/3.7.0/html5shiv.min.js"></script><![endif]-->
  
  
<!-- //插入统计代码 -->

</head>
<body>
  <div class="wrapper">
    <header id="header">
  <div class="title">
    <h1><a href="/">SuperTim&#39;s Page</a></h1>
    <p><a href="/"></a></p>
  </div>
  <nav class="nav">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/about">About</a></li>
      
      
        <li><a href="/atom.xml">RSS</a></li>
      
    </ul>
    <div class="clearfix"></div>
  </nav>
  <div class="clearfix"></div>
</header>
    <div class="content"><article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2017/03/10/kafka_notes/">
  <time datetime="2017-03-10T14:09:51.000Z">
    2017-03-10
  </time>
</a>
    
    
  
    <h1 class="title">kafka-notes</h1>
  

  </header>
  
  <div class="entry">
    
      <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><hr>
<ul>
<li><p>大量log数据产生<br>  包括</p>
<ul>
<li>用户行为数据：登陆，浏览，点击，赞，分享，评论，搜索 ……</li>
<li>机器行为数据：callstack， calllatency， error， cpu，memory，disk，….</li>
</ul>
<p>可以用来</p>
<ul>
<li>搜索相关性，推荐，定向，安全分析<a id="more"></a></li>
</ul>
</li>
<li>现有一些都是非实时系统，都是用来将数据导入数据仓库或者hadoop的</li>
<li>分布式，可拓展，高吞吐，类似消息系统的API</li>
</ul>
<h1 id="Related-Work"><a href="#Related-Work" class="headerlink" title="Related Work"></a>Related Work</h1><hr>
<ul>
<li>传统消息系统不适合做日志处理<ul>
<li>强保证数据一致性</li>
<li>吞吐率低</li>
<li>分布式</li>
<li>不能挤压数据，不能保存长时间不被消费的数据</li>
</ul>
</li>
</ul>
<h1 id="Kafka-Architecture-and-Design-Principles"><a href="#Kafka-Architecture-and-Design-Principles" class="headerlink" title="Kafka Architecture and Design Principles"></a>Kafka Architecture and Design Principles</h1><hr>
<h2 id="Efficiency-on-a-Single-Partition"><a href="#Efficiency-on-a-Single-Partition" class="headerlink" title="Efficiency on a Single Partition"></a>Efficiency on a Single Partition</h2><ul>
<li>Simple storage<ul>
<li>每一个partition是一个逻辑上得log,物理上一个log是由segment组成（1G），publish一个message，会append到最后一个log上<ul>
<li>定时或者超过限额flush到磁盘，flush之后才会被consume到</li>
<li>不存储MessageId，使用offset来定位，len(curMessage) + offset = nextMessage.offset</li>
<li>一个consumer总是从一个partition顺次消费，每一个pull 请求都包括一个offset</li>
<li>每一个broker内存都存储一个有序的offset表</li>
</ul>
</li>
</ul>
</li>
<li><p>Efficient transfer</p>
<ul>
<li>consumer会批量的消费数据</li>
<li>kafka进程进程中不cache数据，使用system的page cache, 避免gc，避免多次cache的浪费，重启cache依然是warm得</li>
<li><p>Finally, since both the producer and the consumer access the segment files sequentially, with the consumer often lagging the producer by a small amount, normal operating system caching heuristics are very effective (specifically write-through caching and read- ahead).</p>
</li>
<li><p>通过ZeroCopy的SendFile减少调用<br>(1）read data from the storage media to the page cache in an OS<br>(2) copy data in the page cache to an application buffer<br>(3) copy application buffer to another kernel buffer,<br>(4) send the kernel buffer to the socket.<br>This includes 4 data copying and 2 system calls. </p>
</li>
</ul>
</li>
<li>Stateless broker<br>  broker无状态，由Consumer记录状态，超时删除</li>
</ul>
<h2 id="Distributed-Coordination"><a href="#Distributed-Coordination" class="headerlink" title="Distributed Coordination"></a>Distributed Coordination</h2><ul>
<li>consumer group之间不需要合作，同一个consumer group内的各个节点需要合作</li>
<li>几个设计考虑<ul>
<li>partition是最小的并行单元，一个partition同时只能被一个consumer消费</li>
<li>没有master节点，去中心化模式，使用zookeeper做一下事情<ul>
<li>检测是否有broker和consumer的上下线</li>
<li>如果有则触发rebalance</li>
<li>维护各个parititon的offset<br>流程</li>
</ul>
</li>
<li>broker 和 consumer启动时注册自身信息</li>
<li>zk上建的path对于broker和consumer都是ephemeral的，对于offset是persistent的</li>
<li>多个consumer rebalance颠簸会停下来</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">Algorithm 1: </div><div class="line">rebalance process for consumer Ci in group G</div><div class="line">For each topic T that Ci subscribes to &#123;</div><div class="line"> // 删掉自己拥有的partition</div><div class="line"> remove partitions owned by Ci from the ownership registry</div><div class="line"> // 从zk上读broker和consumer</div><div class="line"> read the broker and the consumer registries from Zookeeper</div><div class="line"> // 所有可用的consumer和partition</div><div class="line"> compute PT = partitions available in all brokers under topic T</div><div class="line"> compute CT = all consumers in G that subscribe to topic T</div><div class="line"> sort PT and CT</div><div class="line"> let j be the index position of Ci in CT and let N = |PT|/|CT|</div><div class="line"> assign partitions from j*N to (j+1)*N - 1 in PT to consumer Ci</div><div class="line"> for each assigned partition p &#123;</div><div class="line"> 	set the owner of p to Ci in the ownership registry</div><div class="line">	 let Op = the offset of partition p stored in the offset registry</div><div class="line"> 	invoke a thread to pull data in partition p from offset Op</div><div class="line"> &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Delivery-Guarantees"><a href="#Delivery-Guarantees" class="headerlink" title="Delivery Guarantees"></a>Delivery Guarantees</h2><ul>
<li>ExactlyOnce的语义需要两阶段提交，kafka中可以使用业务层的ID</li>
<li>message层面的CRC检查，如果失败则会丢弃</li>
</ul>
<hr>
<p><a href="http://kafka.apache.org/documentation/#design" target="_blank" rel="external">http://kafka.apache.org/documentation/#design</a></p>
<h1 id="TODO：Design-DOC"><a href="#TODO：Design-DOC" class="headerlink" title="TODO：Design DOC"></a>TODO：Design DOC</h1><hr>
<p><a href="http://www.longyu23.com/doc/Kafka.pdf" target="_blank" rel="external">http://www.longyu23.com/doc/Kafka.pdf</a><br><a href="http://kafka.apache.org/documentation/#design" target="_blank" rel="external">http://kafka.apache.org/documentation/#design</a></p>

    
  </div>
  <footer>
    
      
      
  <div class="tags">
    <a class="tags-link" href="/tags/kafka/">kafka</a>
  </div>

      
    
    <div class="clearfix"></div>
  </footer>
</article>


<section id="comment">
  <h1 class="title">Comments</h1>
  <div class="ds-thread" data-thread-key="2017/03/10/kafka_notes/" data-title="kafka-notes" data-url="http://yoursite.com/2017/03/10/kafka_notes/"></div>
</section>
</div>
  </div>
  
  <div id="sidebar" class="widgets-bottom">
  

  
<div class="widget tagcloud">
  <h3 class="title">tagcloud</h3>
  <div class="entry">
    <a href="/tags/kafka/" style="font-size: 10px;">kafka</a>
  </div>
</div>


  
<div class="widget tag">
  <h3 class="title">recent_posts</h3>
  <ul class="entry">
    
      <li>
        <a href="/2017/03/13/java-concurrency-notes/">java-concurrency-notes</a>
      </li>
    
      <li>
        <a href="/2017/03/10/kafka_notes/">kafka-notes</a>
      </li>
    
  </ul>
</div>

</div>
  
  <footer id="footer"><div class="copyright">
  
  &copy; 2017 <a href="/">SuperTim</a>
  
</div>
<div class="theme-copyright">
  Theme by <a href="https://github.com/orderedlist" target="_blank">orderedlist</a>
   | 
  Redesign by <a href="http://blog.dafengning.com/" target="_blank">Chong Zi</a>
</div>
<div class="clearfix"></div></footer>
  <script src="//lib.sinaapp.com/js/jquery/1.8/jquery.min.js"></script>
<script src="/js/scale.fix.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var duoshuoQuery = {short_name:"supertimcheng"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>


<div id="rightfix" style="display:none;">

<a href="#comment" id="gocomm" class="fix_btn" title="提问/评论"><i><i></i></i></a>


<a href="javascript:void(0)" id="gotop" class="fix_btn" onclick="gotop();" title="回到顶部"><i></i></a>
<script>
  function gotop(){
    $('html,body').animate({
        scrollTop : '0px'
      }, 800);
  }
  $(function(){
    _rightfix = $('#rightfix');
    $(window).scroll(function(){
      $sollTop = document.documentElement.scrollTop + document.body.scrollTop;
      if($sollTop > 350){
        _rightfix.show();
      }else{
        _rightfix.hide();
      }
    });
  });
</script>

</div>


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
  (function($){
    $('.fancybox').fancybox();
  })(jQuery);
</script>


</body>
</html>